name: Alerta Docker Image CI

env:
  SVR_IMG_NAME: alerta-server
  SVR_IMG_TAG: latest

  WEB_IMG_NAME: alerta-webui
  WEB_IMG_TAG: latest

  
on:
  push:
    branches:
      - alerta-0.2.0
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: docker:login
      env:
        DOCKERHUB_USERNAME: ${{secrets.DOCKERHUB_USERNAME}}
        DOCKERHUB_PASSWORD: ${{secrets.DOCKERHUB_PASSWORD}}
      run: |
        docker login -u $DOCKERHUB_USERNAME -p $DOCKERHUB_PASSWORD

    - name: buildx-&-push:alerta-server
      run: |
        docker run -d --rm --privileged tonistiigi/binfmt --install all
        docker buildx create --use
        docker buildx build $SVR_IMG_NAME --push --file $SVR_IMG_NAME/Dockerfile --build-arg version=$SVR_IMG_TAG --tag ${{secrets.DOCKERHUB_USERNAME}}/$SVR_IMG_NAME:$SVR_IMG_TAG --tag ${{secrets.DOCKERHUB_USERNAME}}/$SVR_IMG_NAME:latest --platform linux/arm64/v8,linux/amd64 --cache-from $SVR_IMG_NAME:latest

    - name: buildx-&-push:alerta-webui
      run: |
        docker run -d --rm --privileged tonistiigi/binfmt --install all
        docker buildx create --use
        docker buildx build $WEB_IMG_NAME --push --file $WEB_IMG_NAME/Dockerfile --build-arg version=$WEB_IMG_TAG --tag ${{secrets.DOCKERHUB_USERNAME}}/$WEB_IMG_NAME:$WEB_IMG_TAG --tag ${{secrets.DOCKERHUB_USERNAME}}/$WEB_IMG_NAME:latest --platform linux/arm64/v8,linux/amd64 --cache-from $WEB_IMG_NAME:latest        
