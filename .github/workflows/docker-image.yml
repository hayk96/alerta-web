name: Alerta Docker Image CI

env:
  DOCKERHUB_USERNAME: ${{secrets.DOCKERHUB_USERNAME}}
  DOCKERHUB_PASSWORD: ${{secrets.DOCKERHUB_PASSWORD}}

  SVR_IMG_NAME: alerta-server
  SVR_IMG_TAG: latest

  WEB_IMG_NAME: alerta-webui
  WEB_IMG_TAG: latest@sha256:9992f9743ed7b13c441e456b9683825c175a4c29222d50c006cc11e3a39f721d
  
on:
  push:
    branches:
      - alerta-0.2.0
  workflow_dispatch:

jobs:
  build-alerta-server:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: docker:login
      run: |
        docker login -u $DOCKERHUB_USERNAME -p $DOCKERHUB_PASSWORD

    - name: buildx-&-push
      run: |
        docker run -d --rm --privileged tonistiigi/binfmt --install all
        docker buildx create --use
        docker buildx build $SVR_IMG_NAME --push --file $SVR_IMG_NAME/Dockerfile --build-arg version=$SVR_IMG_TAG --tag ${{secrets.DOCKERHUB_USERNAME}}/$SVR_IMG_NAME:$SVR_IMG_TAG --tag ${{secrets.DOCKERHUB_USERNAME}}/$SVR_IMG_NAME:latest --platform linux/arm64/v8,linux/amd64 --cache-from $SVR_IMG_NAME:latest

  build-alerta-webui:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: docker:login
      run: |
        docker login -u $DOCKERHUB_USERNAME -p $DOCKERHUB_PASSWORD

    - name: buildx-&-push
      run: |
        IMG_TAG=$(echo "$WEB_IMG_TAG" | awk -F@ '{print $1}')
        docker run -d --rm --privileged tonistiigi/binfmt --install all
        docker buildx create --use
        docker buildx build $WEB_IMG_NAME --push --file $WEB_IMG_NAME/Dockerfile --build-arg version=$WEB_IMG_TAG --tag ${{secrets.DOCKERHUB_USERNAME}}/$WEB_IMG_NAME:$IMG_TAG --tag ${{secrets.DOCKERHUB_USERNAME}}/$WEB_IMG_NAME:latest --platform linux/arm64/v8,linux/amd64